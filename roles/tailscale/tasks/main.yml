---
# Tailscale role - installs and configures Tailscale VPN

- name: Add Tailscale GPG key
  ansible.builtin.apt_key:
    url: https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg
    keyring: /usr/share/keyrings/tailscale-archive-keyring.gpg
    state: present

- name: Get distribution codename
  ansible.builtin.command: lsb_release -cs
  register: distro_codename
  changed_when: false

- name: Add Tailscale repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu {{ distro_codename.stdout }} main"
    filename: tailscale
    state: present

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: yes

- name: Enable and start tailscaled service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: yes
    state: started

- name: Check Tailscale status
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Parse Tailscale status
  ansible.builtin.set_fact:
    tailscale_logged_in: "{{ (tailscale_status.stdout | from_json).BackendState == 'Running' }}"
  when: tailscale_status.rc == 0

- name: Authenticate with Tailscale
  ansible.builtin.command: >
    tailscale up
    --authkey={{ tailscale_authkey }}
    --accept-routes={{ tailscale_accept_routes | default(false) | lower }}
    {% if tailscale_exit_node | default(false) %}--advertise-exit-node{% endif %}
    --hostname={{ tailscale_hostname | default(inventory_hostname) }}
  when: >
    tailscale_status.rc != 0 or
    not tailscale_logged_in | default(false)
  no_log: true

- name: Get Tailscale IP address
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false

- name: Set Tailscale IP fact
  ansible.builtin.set_fact:
    tailscale_ip: "{{ tailscale_ip_result.stdout | trim }}"
