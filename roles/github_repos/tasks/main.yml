---
# GitHub repos role - deploys SSH key and clones repositories
#
# Supports two modes:
# 1. github_ssh_key_path: Use an existing key on the target system (preferred)
# 2. github_ssh_key: Copy key content to target system

- name: Determine SSH key path
  ansible.builtin.set_fact:
    _github_ssh_key_path: "{{ github_ssh_key_path | default('') }}"
    _github_user_home: "{{ (github_repos_owner == 'root') | ternary('/root', '/home/' + github_repos_owner) }}"

# Mode 1: Use existing key path (no copying needed)
- name: Use existing SSH key path
  when: _github_ssh_key_path | length > 0
  block:
    - name: Verify SSH key exists at specified path
      ansible.builtin.stat:
        path: "{{ _github_ssh_key_path }}"
      register: _ssh_key_stat

    - name: Fail if SSH key not found
      ansible.builtin.fail:
        msg: "SSH key not found at {{ _github_ssh_key_path }}"
      when: not _ssh_key_stat.stat.exists

    - name: Set SSH key path for GitHub
      ansible.builtin.set_fact:
        _effective_ssh_key_path: "{{ _github_ssh_key_path }}"

# Mode 2: Copy key content to target (legacy mode)
- name: Deploy SSH key from content
  when: _github_ssh_key_path | length == 0 and github_ssh_key is defined and github_ssh_key | length > 0
  block:
    - name: Ensure .ssh directory exists for repo owner
      ansible.builtin.file:
        path: "{{ _github_user_home }}/.ssh"
        state: directory
        owner: "{{ github_repos_owner }}"
        group: "{{ github_repos_group }}"
        mode: '0700'

    - name: Deploy GitHub SSH private key
      ansible.builtin.copy:
        content: "{{ github_ssh_key }}"
        dest: "{{ _github_user_home }}/.ssh/{{ github_ssh_key_name }}"
        owner: "{{ github_repos_owner }}"
        group: "{{ github_repos_group }}"
        mode: '0600'
      no_log: true

    - name: Set SSH key path for GitHub (deployed key)
      ansible.builtin.set_fact:
        _effective_ssh_key_path: "{{ _github_user_home }}/.ssh/{{ github_ssh_key_name }}"

# Configure SSH to use the key for GitHub
- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ _github_user_home }}/.ssh"
    state: directory
    owner: "{{ github_repos_owner }}"
    group: "{{ github_repos_group }}"
    mode: '0700'

- name: Configure SSH for GitHub
  ansible.builtin.blockinfile:
    path: "{{ _github_user_home }}/.ssh/config"
    create: yes
    owner: "{{ github_repos_owner }}"
    group: "{{ github_repos_group }}"
    mode: '0600'
    marker: "# {mark} ANSIBLE MANAGED - GitHub configuration"
    block: |
      Host github.com
        HostName github.com
        User git
        IdentityFile {{ _effective_ssh_key_path }}
        IdentitiesOnly yes
        StrictHostKeyChecking accept-new

- name: Ensure parent directories exist for repos
  ansible.builtin.file:
    path: "{{ item.dest | dirname }}"
    state: directory
    owner: "{{ item.owner | default(github_repos_owner) }}"
    group: "{{ item.group | default(github_repos_group) }}"
    mode: '0755'
  loop: "{{ github_repos }}"
  when: github_repos | length > 0

- name: Clone GitHub repositories
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "{{ item.dest }}"
    version: "{{ item.version | default('main') }}"
    accept_hostkey: yes
    force: "{{ item.force | default(false) }}"
    depth: "{{ item.depth | default(omit) }}"
    recursive: "{{ item.recursive | default(true) }}"
  become: yes
  become_user: "{{ item.owner | default(github_repos_owner) }}"
  loop: "{{ github_repos }}"
  when: github_repos | length > 0

- name: Set ownership on cloned repositories
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: directory
    owner: "{{ item.owner | default(github_repos_owner) }}"
    group: "{{ item.group | default(github_repos_group) }}"
    recurse: yes
  loop: "{{ github_repos }}"
  when: github_repos | length > 0
