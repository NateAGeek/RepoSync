---
# Fetch additional pages of repositories from GitHub API
# This file is included recursively until all pages are fetched

- name: Fetch page {{ _github_page }} from GitHub API
  ansible.builtin.uri:
    url: "https://api.github.com/user/repos?per_page={{ github_fetch_per_page }}&page={{ _github_page }}&visibility={{ github_fetch_visibility }}&affiliation=owner"
    method: GET
    headers:
      Authorization: "Bearer {{ github_token }}"
      Accept: "application/vnd.github+json"
      X-GitHub-Api-Version: "2022-11-28"
    return_content: yes
    status_code: 200
  register: _github_page_response
  until: _github_page_response.status == 200
  retries: 3
  delay: 5

- name: Append page {{ _github_page }} results
  ansible.builtin.set_fact:
    _github_all_repos: "{{ _github_all_repos + _github_page_response.json }}"
    _github_has_more: "{{ (_github_page_response.json | length) == (github_fetch_per_page | int) }}"
    _github_page: "{{ _github_page | int + 1 }}"

- name: Fetch next page if more results exist
  ansible.builtin.include_tasks: fetch_page.yml
  when: _github_has_more | bool
