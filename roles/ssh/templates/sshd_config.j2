# {{ ansible_managed }}
# Hardened SSH Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

# ===========================================
# NETWORK CONFIGURATION
# ===========================================
Port {{ ssh_port }}
{% if ssh_keep_port_22 | default(false) and ssh_port != 22 %}
Port 22
{% endif %}
AddressFamily inet
ListenAddress 0.0.0.0

# ===========================================
# HOST KEYS - ed25519 only
# ===========================================
HostKey /etc/ssh/ssh_host_ed25519_key
HostKeyAlgorithms {{ ssh_host_key_algorithms | join(',') }}

# ===========================================
# AUTHENTICATION - Keys only, no passwords
# ===========================================
# Public key authentication
PubkeyAuthentication yes
PubkeyAcceptedKeyTypes {{ ssh_pubkey_accepted_types | join(',') }}
AuthorizedKeysFile .ssh/authorized_keys

# Disable all password-based authentication
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no

# Disable PAM (removes keyboard-interactive attack surface)
UsePAM no

# Authentication methods - public key only
AuthenticationMethods publickey

# Disable root login entirely
PermitRootLogin {{ 'prohibit-password' if ssh_permit_root_login | default(false) else 'no' }}

# Only allow specific users
{% if ssh_permit_root_login | default(false) %}
AllowUsers root {{ ssh_allow_users | join(' ') }}
{% else %}
AllowUsers {{ ssh_allow_users | join(' ') }}
{% endif %}

# ===========================================
# CRYPTOGRAPHY - Modern algorithms only
# ===========================================
# Ciphers (AEAD modes only)
Ciphers {{ ssh_ciphers | join(',') }}

# Key exchange algorithms
KexAlgorithms {{ ssh_kex_algorithms | join(',') }}

# Message authentication codes (ETM modes only)
MACs {{ ssh_macs | join(',') }}

# ===========================================
# ANTI-BRUTE-FORCE / ANTI-SCANNING
# ===========================================
# Maximum authentication attempts before disconnect
MaxAuthTries {{ ssh_max_auth_tries }}

# Time allowed to authenticate (seconds)
LoginGraceTime {{ ssh_login_grace_time }}

# Maximum concurrent sessions per connection
MaxSessions {{ ssh_max_sessions }}

# Rate limiting: start:rate:full
# start = refuse after N unauthenticated connections
# rate = percentage chance to refuse additional connections
# full = refuse all connections above this count
MaxStartups {{ ssh_max_startups }}

# ===========================================
# FEATURE RESTRICTIONS
# ===========================================
# Disable X11 forwarding (attack surface reduction)
X11Forwarding no

# Disable agent forwarding (prevents lateral movement)
AllowAgentForwarding no

# Allow TCP forwarding (needed for Syncthing tunnel)
AllowTcpForwarding {{ 'yes' if ssh_allow_tcp_forwarding else 'no' }}

# Disable tunnel devices
PermitTunnel no

# Disable user environment files
PermitUserEnvironment no

# Disable .rhosts and hosts.equiv
IgnoreRhosts yes
HostbasedAuthentication no

# ===========================================
# LOGGING
# ===========================================
# Log level (INFO is sufficient, VERBOSE for debugging)
LogLevel INFO
SyslogFacility AUTH

# ===========================================
# MISCELLANEOUS
# ===========================================
# Print last login (useful for noticing unauthorized access)
PrintLastLog yes

# Disable motd (reduces information disclosure)
PrintMotd no

# Enable strict modes (check file permissions)
StrictModes yes

# Use privilege separation (deprecated in OpenSSH 7.5+, but harmless)
# UsePrivilegeSeparation sandbox

# Client alive interval (detect dead connections)
ClientAliveInterval 300
ClientAliveCountMax 2

# Disable DNS lookups (faster, no information leak)
UseDNS no

# Disable TCP keepalive at application layer (use ClientAlive instead)
TCPKeepAlive no

# Banner (optional - uncomment to show warning)
# Banner /etc/ssh/banner.txt
