---
# Main playbook - orchestrates all roles
#
# Usage (Interactive Mode - prompts for secrets):
#   ansible-playbook playbooks/site.yml
#
# Usage (Vault Mode - uses encrypted vault):
#   ansible-playbook playbooks/site.yml --ask-vault-pass
#   ansible-playbook playbooks/site.yml --vault-password-file ~/.vault_pass
#
# Run specific roles with tags:
#   ansible-playbook playbooks/site.yml --tags "firewall"
#   ansible-playbook playbooks/site.yml --tags "syncthing,github"
#
# Skip roles:
#   ansible-playbook playbooks/site.yml --skip-tags "ssh,firewall"

- name: Configure infrastructure
  hosts: all
  become: true
  gather_facts: true

  vars_prompt:
    # SSH Public Key
    - name: prompt_ssh_public_key
      prompt: |

        ============================================
        SSH ACCESS SETUP
        ============================================
        Enter your SSH public key (ed25519)
        (e.g., ssh-ed25519 AAAA... user@host)
        Leave blank to use vault value
      private: no
      default: ""

    # GitHub Username
    - name: prompt_github_username
      prompt: |

        ============================================
        GITHUB SETUP
        ============================================
        Enter your GitHub username
        Leave blank to use config value
      private: no
      default: ""

    # GitHub Token
    - name: prompt_github_token
      prompt: |
        Enter your GitHub Personal Access Token
        (Get one at https://github.com/settings/tokens - needs 'repo' scope)
        Leave blank to use vault value
      private: yes
      default: ""

    # GitHub SSH Key
    - name: prompt_github_ssh_key
      prompt: |
        Enter the path to your SSH private key ON THE TARGET SYSTEM
        (e.g., /root/.ssh/id_ed25519 or /home/deploy/.ssh/id_ed25519)
        This key must already exist on the target and be added to GitHub
        Leave blank to skip GitHub repo cloning
      private: no
      default: ""

    # Syncthing Password
    - name: prompt_syncthing_password
      prompt: |

        ============================================
        SYNCTHING SETUP
        ============================================
        Enter a password for Syncthing Web GUI
        Leave blank for no authentication
      private: yes
      default: ""

  pre_tasks:
    # Set effective values (prompt overrides vault/config)
    - name: Set effective SSH user public key
      ansible.builtin.set_fact:
        ssh_user_public_key: "{{ prompt_ssh_public_key if prompt_ssh_public_key | length > 0 else (vault_ssh_user_public_key | default('')) }}"

    - name: Set effective GitHub username
      ansible.builtin.set_fact:
        github_username: "{{ prompt_github_username if prompt_github_username | length > 0 else (vault_github_username | default(github_username | default(''))) }}"

    - name: Set effective GitHub token
      ansible.builtin.set_fact:
        github_token: "{{ prompt_github_token if prompt_github_token | length > 0 else (vault_github_token | default('')) }}"

    - name: Set effective GitHub SSH key path
      ansible.builtin.set_fact:
        github_ssh_key_path: "{{ prompt_github_ssh_key if prompt_github_ssh_key | length > 0 else (vault_github_ssh_key_path | default(github_ssh_key_path | default(''))) }}"

    - name: Set effective Syncthing password
      ansible.builtin.set_fact:
        syncthing_gui_password: "{{ prompt_syncthing_password if prompt_syncthing_password | length > 0 else (vault_syncthing_gui_password | default('')) }}"

    - name: Set effective Syncthing devices
      ansible.builtin.set_fact:
        syncthing_devices: "{{ vault_syncthing_devices | default(syncthing_devices | default([])) }}"

    # Validate required variables
    - name: Validate SSH user public key
      ansible.builtin.assert:
        that:
          - ssh_user_public_key is defined
          - ssh_user_public_key | length > 0
        fail_msg: |
          
          ERROR: SSH public key is required!
          
          Generate one with: ssh-keygen -t ed25519 -C "your-email"
          
          Either:
            1. Enter it when prompted, OR
            2. Set vault_ssh_user_public_key in your vault.yml
        success_msg: "SSH public key: configured"
      tags: always

    - name: Validate GitHub username
      ansible.builtin.assert:
        that:
          - github_username is defined
          - github_username | length > 0
        fail_msg: |
          
          ERROR: GitHub username is required!
          
          Either:
            1. Enter it when prompted, OR
            2. Set github_username in inventory/group_vars/all/main.yml
        success_msg: "GitHub username: {{ github_username }}"
      when: github_fetch_enabled | default(true) | bool
      tags: always

    - name: Validate GitHub token
      ansible.builtin.assert:
        that:
          - github_token is defined
          - github_token | length > 0
        fail_msg: |
          
          ERROR: GitHub token is required for repository discovery!
          
          Get one at: https://github.com/settings/tokens
          Required scopes: repo (for private repos)
          
          Either:
            1. Enter it when prompted, OR
            2. Set vault_github_token in your vault.yml
        success_msg: "GitHub token: configured"
      when: github_fetch_enabled | default(true) | bool
      tags: always

    - name: Validate GitHub SSH key path
      ansible.builtin.assert:
        that:
          - github_ssh_key_path is defined
          - github_ssh_key_path | length > 0
        fail_msg: |
          
          ERROR: GitHub SSH key path is required for cloning repositories!
          
          The SSH key must exist on the target system.
          Example paths:
            - /root/.ssh/id_ed25519
            - /home/deploy/.ssh/id_ed25519
          
          Make sure the public key is added to: https://github.com/settings/keys
          
          Enter the path when prompted, or set github_ssh_key_path in main.yml
        success_msg: "GitHub SSH key path: {{ github_ssh_key_path }}"
      when: github_fetch_enabled | default(true) | bool
      tags: always

    - name: Display configuration summary
      ansible.builtin.debug:
        msg: |
          
          ============================================
          CONFIGURATION SUMMARY
          ============================================
          Target Host: {{ inventory_hostname }}
          SSH User:    {{ ssh_user | default('deploy') }}
          SSH Port:    {{ ssh_port | default(9438) }}
          SSH Key:     {{ 'configured' if ssh_user_public_key | default('') | length > 0 else 'NOT SET' }}
          GitHub User: {{ github_username | default('not set') }}
          GitHub Auth: {{ 'configured' if github_token | default('') | length > 0 else 'not set' }}
          GitHub Key:  {{ github_ssh_key_path | default('not set') }}
          Syncthing:   {{ 'password set' if syncthing_gui_password | default('') | length > 0 else 'no password' }}
          ============================================
          
      tags: always

  roles:
    - role: common
      tags:
        - common
        - base

    - role: sshguard
      tags:
        - sshguard
        - security

    - role: ssh
      tags:
        - ssh
        - security

    - role: firewall
      tags:
        - firewall
        - security

    - role: github_fetch_repos
      tags:
        - github
        - fetch
      when: github_fetch_enabled | default(true) | bool

    - role: github_repos
      tags:
        - github
        - repos
      when: github_repos is defined and github_repos | length > 0

    - role: github_sync
      tags:
        - github
        - sync
        - cron
      when: github_repos is defined and github_repos | length > 0 and github_sync_enabled | default(true) | bool

    - role: syncthing
      tags:
        - syncthing
        - sync

  post_tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          
          ========================================
          SETUP COMPLETE FOR {{ inventory_hostname }}
          ========================================
          
          SSH ACCESS
            User: {{ ssh_user | default('deploy') }}
            Port: {{ ssh_port | default(9438) }}
            Auth: ed25519 keys only (no passwords)
            Root: disabled
            Protection: SSHGuard active (blocks after failed attempts)
          
          FIREWALL
            Inbound: DENY (except SSH {{ ssh_port | default(9438) }}/tcp)
            Outbound: DENY (except DNS, NTP, HTTP, HTTPS)
            Rate limit: Active on SSH port
          
          SYNCTHING  
            Device ID: {{ syncthing_local_device_id | default('N/A') }}
            Web GUI: http://127.0.0.1:8384 (via SSH tunnel)
            Username: {{ syncthing_gui_user | default('admin') }}
          
          {% if github_repos is defined and github_repos | length > 0 %}
          GITHUB REPOSITORIES
            Cloned: {{ github_repos | length }} repos
            Location: {{ github_repos_base_path | default('/opt/repos') }}
            Auto-sync: {{ 'Every 15 min' if github_sync_enabled | default(true) else 'Disabled' }}
          {% endif %}
          
          ========================================
          CONNECT TO YOUR SERVER
          ========================================
          
          SSH access:
            ssh -p {{ ssh_port | default(9438) }} {{ ssh_user | default('deploy') }}@{{ inventory_hostname }}
          
          Syncthing GUI (via SSH tunnel):
            ssh -L 8384:localhost:8384 -p {{ ssh_port | default(9438) }} {{ ssh_user | default('deploy') }}@{{ inventory_hostname }}
            Then open: http://localhost:8384
          
          ========================================
      tags: always
